---
import PageLayout from '../../layouts/PageLayout.astro';
import Breadcrumb from '../../components/astro/Breadcrumb.astro';
import TagBadge from '../../components/astro/TagBadge.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { getRoleName } from '../../lib/utils';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { id: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

// Resolve team members
const teamMembers = [];
if (project.data.team) {
  for (const personId of project.data.team) {
    const person = await getEntry('people', personId);
    if (person) teamMembers.push(person);
  }
}
---

<PageLayout title={project.data.title} description={project.data.excerpt}>
  <Breadcrumb />

  <div class="mt-4">
    <!-- Status & type badges -->
    <div class="flex items-center gap-2 mb-3 text-xs">
      <span class:list={[
        'px-2 py-0.5 rounded capitalize',
        project.data.status === 'active'
          ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400'
          : project.data.status === 'upcoming'
            ? 'bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-400'
            : 'bg-surface-100 text-surface-500 dark:bg-[#161b22] dark:text-[#8b949e]'
      ]}>
        {project.data.status}
      </span>
      <span class="px-2 py-0.5 rounded capitalize bg-surface-100 text-surface-600 dark:bg-[#161b22] dark:text-[#8b949e]">
        {project.data.type}
      </span>
    </div>

    <h1 class="text-2xl sm:text-3xl font-serif font-normal text-surface-900 dark:text-[#e6edf3] mb-2">
      {project.data.title}
    </h1>

    {project.data.excerpt && (
      <p class="text-sm text-surface-500 dark:text-[#8b949e] mb-4">{project.data.excerpt}</p>
    )}

    <!-- Links -->
    <div class="flex flex-wrap items-center gap-3 mb-6 text-sm">
      {project.data.url && (
        <a
          href={project.data.url}
          target="_blank"
          rel="noopener noreferrer"
          class="text-primary-600 dark:text-accent-400 hover:underline"
        >
          Website
        </a>
      )}
      {project.data.repoUrl && (
        <a
          href={project.data.repoUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="text-primary-600 dark:text-accent-400 hover:underline"
        >
          Source Code
        </a>
      )}
      {project.data.paperUrl && (
        <a
          href={project.data.paperUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="text-primary-600 dark:text-accent-400 hover:underline"
        >
          Paper
        </a>
      )}
    </div>

    {project.data.tags && project.data.tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-6">
        {project.data.tags.map(tag => (
          <TagBadge tag={tag} />
        ))}
      </div>
    )}

    <!-- Content -->
    <div class="prose mb-8">
      <Content />
    </div>

    <!-- Team -->
    {teamMembers.length > 0 && (
      <section class="pt-6 border-t border-surface-200 dark:border-[#21262d]">
        <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] mb-3">Team</h2>
        <div class="flex flex-wrap gap-3">
          {teamMembers.map(member => (
            <a href={`/people/${member.id}`} class="flex items-center gap-2 px-3 py-2 rounded border border-surface-200 dark:border-[#21262d] hover:border-primary-300 dark:hover:border-accent-500 transition-colors text-sm">
              <div class="w-7 h-7 rounded-full bg-surface-100 dark:bg-[#161b22] flex items-center justify-center text-xs font-medium text-surface-500 dark:text-[#8b949e]">
                {member.data.name.split(' ').map(n => n[0]).join('')}
              </div>
              <div>
                <span class="text-surface-900 dark:text-[#e6edf3]">{member.data.name}</span>
                <span class="text-surface-400 dark:text-[#484f58] ms-1">{getRoleName(member.data.role)}</span>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</PageLayout>
