---
import PageLayout from '../../layouts/PageLayout.astro';
import PostCard from '../../components/astro/PostCard.astro';
import FeedItem from '../../components/astro/FeedItem.astro';
import { getCollection } from 'astro:content';
import { isPersonalMode } from '../../lib/config';

const personal = isPersonalMode();

const posts = (await getCollection('posts'))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const feeds = (await getCollection('feeds'))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Combine into a unified timeline
type TimelineItem = {
  type: 'post' | 'feed';
  date: Date;
  data: typeof posts[0] | typeof feeds[0];
};

const timeline: TimelineItem[] = [
  ...posts.map(p => ({ type: 'post' as const, date: p.data.date, data: p })),
  ...feeds.map(f => ({ type: 'feed' as const, date: new Date(f.data.date), data: f })),
].sort((a, b) => b.date.getTime() - a.date.getTime());
---

<PageLayout title="Blog" description={personal ? "Posts, articles, and technical writing." : "Lab blog posts and external articles from our team."}>
  <h1 class="text-2xl sm:text-3xl font-serif font-normal text-surface-900 dark:text-dm-heading mb-2">Blog</h1>
  <p class="text-sm text-surface-500 dark:text-dm-muted mb-6">
    {personal ? "Posts, articles, and technical writing." : "Posts from our team, including lab blog entries and external articles."}
  </p>

  <!-- All tags -->
  {(() => {
    const allTags = [...new Set(posts.flatMap(p => p.data.tags || []))].sort();
    return allTags.length > 0 ? (
      <div class="flex flex-wrap items-center gap-2 mb-6 text-xs">
        <span class="text-surface-400 dark:text-dm-faint">Tags:</span>
        {allTags.map(tag => (
          <a
            href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
            class="text-surface-500 dark:text-dm-muted hover:text-primary-600 dark:hover:text-accent-400 transition-colors"
          >
            #{tag.toLowerCase().replace(/\s+/g, '-')}
          </a>
        ))}
      </div>
    ) : null;
  })()}

  <div class="divide-y divide-surface-100 dark:divide-dm-border">
    {timeline.map(item => {
      if (item.type === 'post') {
        const post = item.data as typeof posts[0];
        return (
          <PostCard
            id={post.id}
            title={post.data.title}
            date={post.data.date}
            excerpt={post.data.excerpt}
            tags={post.data.tags}
            author={post.data.author}
          />
        );
      } else {
        const feed = item.data as typeof feeds[0];
        return (
          <FeedItem
            title={feed.data.title}
            link={feed.data.link}
            date={feed.data.date}
            source={feed.data.source}
            excerpt={feed.data.excerpt}
            author={feed.data.author}
          />
        );
      }
    })}
  </div>
</PageLayout>
