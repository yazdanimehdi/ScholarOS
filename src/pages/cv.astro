---
import PageLayout from '../layouts/PageLayout.astro';
import PublicationEntry from '../components/astro/PublicationEntry.astro';
import { getCollection } from 'astro:content';
import { getSiteConfig, loadYamlConfig, normalizeKeys } from '../lib/config';
import type { CvConfig, CvMetadata, CvGenericEntry } from '../lib/types';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

const config = getSiteConfig();

// Check raw YAML upload first, fall back to structured config
let cvConfig: CvConfig;
let usingUpload = false;
try {
  const upload = loadYamlConfig<{ enabled?: boolean; content?: string }>('cv-upload.yml');
  if (upload?.enabled && upload.content?.trim()) {
    const parsed = normalizeKeys(yaml.load(upload.content) as CvConfig);
    if (parsed?.cv) {
      cvConfig = parsed;
      usingUpload = true;
    } else {
      cvConfig = loadYamlConfig<CvConfig>('cv.yml');
    }
  } else {
    cvConfig = loadYamlConfig<CvConfig>('cv.yml');
  }
} catch {
  cvConfig = loadYamlConfig<CvConfig>('cv.yml');
}

const cv = cvConfig.cv;
const sections = cv.sections ?? {};

const publications = (await getCollection('publications')).sort((a, b) => b.data.year - a.data.year);

// Load CV metadata if available (generated by render-cv.py)
let cvMeta: CvMetadata | null = null;
try {
  const metaPath = path.resolve(process.cwd(), 'src/data/cv.json');
  const raw = fs.readFileSync(metaPath, 'utf-8');
  cvMeta = JSON.parse(raw) as CvMetadata;
} catch {
  // No metadata yet — PDF hasn't been generated
}

const hasPdf = cvMeta?.pdfPath != null;
const pdfHref = hasPdf ? cvMeta!.pdfPath : '#';

function formatDateRange(start?: string, end?: string): string {
  if (!start) return '';
  const s = start.length === 7 ? start : start;
  const e = end === 'present' ? 'Present' : (end ?? '');
  return `${s} – ${e}`;
}

// Compute extra sections not handled by the 5 known blocks
const KNOWN_SECTIONS = new Set(['education', 'experience', 'publications', 'awards', 'skills']);
const extraSections = Object.entries(sections)
  .filter(([key]) => !KNOWN_SECTIONS.has(key))
  .filter(([, entries]) => Array.isArray(entries) && entries.length > 0) as [string, unknown[]][];

function sectionTitle(key: string): string {
  // camelCase → spaced, then title-case each word
  return key
    .replace(/([a-z])([A-Z])/g, '$1 $2')
    .replace(/^./, (c) => c.toUpperCase());
}

function isOneLineEntry(e: unknown): e is { label: string; details: string } {
  return typeof e === 'object' && e !== null && 'label' in e && 'details' in e;
}

function isExperienceEntry(e: unknown): e is CvGenericEntry {
  return typeof e === 'object' && e !== null && ('company' in e || 'position' in e);
}

function isPublicationEntry(e: unknown): e is CvGenericEntry {
  return typeof e === 'object' && e !== null && 'title' in e && 'authors' in e;
}

function isNormalEntry(e: unknown): e is CvGenericEntry {
  return typeof e === 'object' && e !== null && ('name' in e || 'startDate' in e || 'highlights' in e);
}
---

<PageLayout title="CV" description={`Curriculum Vitae of ${cv.name || config.author}`}>
  <div class="mb-6 flex items-start justify-between gap-4">
    <div>
      <h1 class="mb-1 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">
        {cv.name || config.author}
      </h1>
      {cv.location && <p class="text-sm text-surface-500 dark:text-dm-muted">{cv.location}</p>}
      {(config.department || config.university) && (
        <p class="text-sm text-surface-500 dark:text-dm-muted">
          {[config.department, config.university].filter(Boolean).join(', ')}
        </p>
      )}
      <div class="mt-1 flex flex-wrap gap-3 text-xs text-surface-500 dark:text-dm-muted">
        {cv.email && <span>{cv.email}</span>}
        {
          cv.website && (
            <a href={cv.website} class="text-primary-600 hover:underline dark:text-accent-400">
              {cv.website}
            </a>
          )
        }
      </div>
    </div>
    <a
      href={pdfHref}
      class:list={[
        'inline-flex shrink-0 items-center gap-1.5 rounded border border-surface-200 px-3 py-1.5 text-sm transition-colors dark:border-dm-border',
        hasPdf
          ? 'text-primary-600 hover:bg-surface-50 dark:text-accent-400 dark:hover:bg-[#161b22]'
          : 'pointer-events-none cursor-not-allowed text-surface-400 dark:text-dm-faint',
      ]}
      {...hasPdf ? { download: 'cv.pdf' } : {}}
    >
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
        ><path
          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        ></path></svg
      >
      Download PDF
    </a>
  </div>

  {
    cvMeta?.lastGenerated && (
      <p class="mb-6 text-xs text-surface-400 dark:text-dm-faint">
        PDF last generated:{' '}
        {new Date(cvMeta.lastGenerated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
      </p>
    )
  }

  <!-- Education -->
  {
    sections.education && sections.education.length > 0 && (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Education
        </h2>
        <div class="space-y-3">
          {sections.education.map((edu) => (
            <div>
              <div class="flex items-baseline justify-between">
                <div>
                  <h3 class="text-sm font-medium text-surface-900 dark:text-dm-heading">
                    {edu.degree} in {edu.area}
                  </h3>
                  <p class="text-sm text-surface-500 dark:text-dm-muted">{edu.institution}</p>
                </div>
                <span class="ms-4 shrink-0 text-xs text-surface-400 dark:text-dm-faint">
                  {formatDateRange(edu.startDate, edu.endDate)}
                </span>
              </div>
              {edu.highlights && edu.highlights.length > 0 && (
                <ul class="mt-1 list-inside list-disc text-xs text-surface-500 dark:text-dm-muted">
                  {edu.highlights.map((h) => (
                    <li>{h}</li>
                  ))}
                </ul>
              )}
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Experience -->
  {
    sections.experience && sections.experience.length > 0 && (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Experience
        </h2>
        <div class="space-y-3">
          {sections.experience.map((exp) => (
            <div>
              <div class="flex items-baseline justify-between">
                <div>
                  <h3 class="text-sm font-medium text-surface-900 dark:text-dm-heading">{exp.position}</h3>
                  <p class="text-sm text-surface-500 dark:text-dm-muted">{exp.company}</p>
                </div>
                <span class="ms-4 shrink-0 text-xs text-surface-400 dark:text-dm-faint">
                  {formatDateRange(exp.startDate, exp.endDate)}
                </span>
              </div>
              {exp.highlights && exp.highlights.length > 0 && (
                <ul class="mt-1 list-inside list-disc text-xs text-surface-500 dark:text-dm-muted">
                  {exp.highlights.map((h) => (
                    <li>{h}</li>
                  ))}
                </ul>
              )}
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Publications -->
  {
    sections.publications && sections.publications.length > 0 ? (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Publications
          <a
            href="/publications"
            class="float-end font-sans text-xs text-primary-600 hover:underline dark:text-accent-400"
          >
            View all &rarr;
          </a>
        </h2>
        <div class="space-y-3">
          {sections.publications.map((pub) => {
            const cleanAuthors = pub.authors.map((a) => a.replace(/\*+/g, ''));
            return (
              <div class="text-sm">
                <p class="font-medium text-surface-900 dark:text-dm-heading">{pub.title}</p>
                <p class="text-surface-500 dark:text-dm-muted">
                  {pub.authors.map((author, i) => {
                    const clean = author.replace(/\*+/g, '');
                    const isBold = author.startsWith('**');
                    return (
                      <>
                        {i > 0 && ', '}
                        {isBold ? <strong>{clean}</strong> : <span>{clean}</span>}
                      </>
                    );
                  })}
                </p>
                <p class="text-surface-400 dark:text-dm-faint">
                  {pub.journal && <span>{pub.journal}</span>}
                  {pub.journal && pub.date && <span> · </span>}
                  {pub.date && <span>{pub.date}</span>}
                  {pub.doi && (
                    <>
                      <span> · </span>
                      <a
                        href={`https://doi.org/${pub.doi}`}
                        class="text-primary-600 hover:underline dark:text-accent-400"
                      >
                        DOI
                      </a>
                    </>
                  )}
                  {pub.url && (
                    <>
                      <span> · </span>
                      <a href={pub.url} class="text-primary-600 hover:underline dark:text-accent-400">
                        Link
                      </a>
                    </>
                  )}
                </p>
              </div>
            );
          })}
        </div>
      </section>
    ) : (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Selected Publications
          <a
            href="/publications"
            class="float-end font-sans text-xs text-primary-600 hover:underline dark:text-accent-400"
          >
            View all &rarr;
          </a>
        </h2>
        <div class="space-y-3">
          {publications.slice(0, 5).map((pub) => (
            <PublicationEntry
              title={pub.data.title}
              authors={pub.data.authors}
              venue={pub.data.venue}
              year={pub.data.year}
              doi={pub.data.doi}
              url={pub.data.url}
              type={pub.data.type}
              highlightAuthors={[config.author]}
            />
          ))}
        </div>
      </section>
    )
  }

  <!-- Awards -->
  {
    sections.awards && sections.awards.length > 0 && (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Awards & Honors
        </h2>
        <div class="space-y-2">
          {sections.awards.map((item) => (
            <div class="flex items-center justify-between text-sm">
              <span class="text-surface-700 dark:text-dm-text">{item.label}</span>
              <span class="text-xs text-surface-400 dark:text-dm-faint">{item.details}</span>
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Skills -->
  {
    sections.skills && sections.skills.length > 0 && (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          Skills
        </h2>
        <div class="space-y-2">
          {sections.skills.map((item) => (
            <div class="flex items-baseline gap-2 text-sm">
              <span class="shrink-0 font-medium text-surface-900 dark:text-dm-heading">{item.label}:</span>
              <span class="text-surface-600 dark:text-dm-text">{item.details}</span>
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Extra / generic sections -->
  {
    extraSections.map(([key, entries]) => (
      <section class="mb-8">
        <h2 class="mb-3 border-b border-surface-200 pb-2 font-serif text-lg font-normal text-surface-900 dark:border-dm-border dark:text-dm-heading">
          {sectionTitle(key)}
        </h2>
        <div class="space-y-3">
          {entries.map((entry) => {
            const e = entry as CvGenericEntry;
            if (typeof entry === 'string') {
              return <p class="text-sm text-surface-600 dark:text-dm-text">{entry}</p>;
            }
            if (isOneLineEntry(entry)) {
              return (
                <div class="flex items-baseline gap-2 text-sm">
                  <span class="shrink-0 font-medium text-surface-900 dark:text-dm-heading">{entry.label}:</span>
                  <span class="text-surface-600 dark:text-dm-text">{entry.details}</span>
                </div>
              );
            }
            if (isExperienceEntry(entry)) {
              return (
                <div>
                  <div class="flex items-baseline justify-between">
                    <div>
                      <h3 class="text-sm font-medium text-surface-900 dark:text-dm-heading">{e.position as string ?? ''}</h3>
                      <p class="text-sm text-surface-500 dark:text-dm-muted">
                        {[e.company, e.location].filter(Boolean).join(', ')}
                      </p>
                    </div>
                    <span class="ms-4 shrink-0 text-xs text-surface-400 dark:text-dm-faint">
                      {formatDateRange(e.startDate, e.endDate)}
                    </span>
                  </div>
                  {e.highlights && e.highlights.length > 0 && (
                    <ul class="mt-1 list-inside list-disc text-xs text-surface-500 dark:text-dm-muted">
                      {e.highlights.map((h) => (
                        <li>{h}</li>
                      ))}
                    </ul>
                  )}
                </div>
              );
            }
            if (isPublicationEntry(entry)) {
              const authors = (e.authors as string[]) ?? [];
              return (
                <div class="text-sm">
                  <p class="font-medium text-surface-900 dark:text-dm-heading">{e.title as string}</p>
                  <p class="text-surface-500 dark:text-dm-muted">
                    {authors.map((author: string, i: number) => {
                      const clean = author.replace(/\*+/g, '');
                      const isBold = author.startsWith('**');
                      return (
                        <>
                          {i > 0 && ', '}
                          {isBold ? <strong>{clean}</strong> : <span>{clean}</span>}
                        </>
                      );
                    })}
                  </p>
                  <p class="text-surface-400 dark:text-dm-faint">
                    {e.journal && <span>{e.journal as string}</span>}
                    {e.journal && e.date && <span> · </span>}
                    {e.date && <span>{e.date}</span>}
                    {e.doi && (
                      <>
                        <span> · </span>
                        <a
                          href={`https://doi.org/${e.doi}`}
                          class="text-primary-600 hover:underline dark:text-accent-400"
                        >
                          DOI
                        </a>
                      </>
                    )}
                    {e.url && (
                      <>
                        <span> · </span>
                        <a href={e.url} class="text-primary-600 hover:underline dark:text-accent-400">
                          Link
                        </a>
                      </>
                    )}
                  </p>
                </div>
              );
            }
            if (isNormalEntry(entry)) {
              return (
                <div>
                  <div class="flex items-baseline justify-between">
                    <h3 class="text-sm font-medium text-surface-900 dark:text-dm-heading">
                      {e.name ?? ''}
                    </h3>
                    <span class="ms-4 shrink-0 text-xs text-surface-400 dark:text-dm-faint">
                      {e.startDate ? formatDateRange(e.startDate, e.endDate) : (e.date ?? '')}
                    </span>
                  </div>
                  {e.location && (
                    <p class="text-sm text-surface-500 dark:text-dm-muted">{e.location}</p>
                  )}
                  {e.highlights && e.highlights.length > 0 && (
                    <ul class="mt-1 list-inside list-disc text-xs text-surface-500 dark:text-dm-muted">
                      {e.highlights.map((h) => (
                        <li>{h}</li>
                      ))}
                    </ul>
                  )}
                </div>
              );
            }
            return null;
          })}
        </div>
      </section>
    ))
  }
</PageLayout>
