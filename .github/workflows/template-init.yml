name: Initialize Template

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write

jobs:
  init:
    runs-on: ubuntu-latest
    # Only run on repos generated from this template, not on the template itself
    if: ${{ !github.event.repository.is_template }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if template needs initialization
        id: check
        run: |
          # If cms.yml still has the default placeholder, this is an uninitialized template
          if grep -q 'repo: "your-username/your-repo"' config/cms.yml; then
            echo "needs_init=true" >> "$GITHUB_OUTPUT"
          else
            echo "needs_init=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure template
        if: steps.check.outputs.needs_init == 'true'
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
        run: |
          # Update adminUsers in site.yml
          sed -i "s/- \"janesmith\"/- \"${OWNER}\"/" config/site.yml

          # Update repo in cms.yml
          sed -i "s|repo: \"your-username/your-repo\"|repo: \"${REPO}\"|" config/cms.yml

      - name: Commit changes
        if: steps.check.outputs.needs_init == 'true'
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add config/site.yml config/cms.yml
          git diff --cached --quiet || git commit -m "chore: initialize template for ${OWNER}"
          git pull --rebase
          git push

      - name: Determine site URL
        if: steps.check.outputs.needs_init == 'true'
        id: url
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # username.github.io repos are served at the root
          if [ "${REPO_NAME}" = "${OWNER}.github.io" ]; then
            echo "site_url=https://${OWNER}.github.io" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://${OWNER}.github.io/admin/" >> "$GITHUB_OUTPUT"
          else
            echo "site_url=https://${OWNER}.github.io/${REPO_NAME}" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://${OWNER}.github.io/${REPO_NAME}/admin/" >> "$GITHUB_OUTPUT"
          fi

      - name: Create setup issue
        if: steps.check.outputs.needs_init == 'true'
        uses: actions/github-script@v7
        env:
          SITE_URL: ${{ steps.url.outputs.site_url }}
          ADMIN_URL: ${{ steps.url.outputs.admin_url }}
        with:
          script: |
            const siteUrl = process.env.SITE_URL;
            const adminUrl = process.env.ADMIN_URL;
            const owner = context.repo.owner;

            // Ensure the label exists before using it
            try {
              await github.rest.issues.getLabel({ ...context.repo, name: 'setup' });
            } catch {
              await github.rest.issues.createLabel({ ...context.repo, name: 'setup', color: '0075ca' });
            }

            await github.rest.issues.create({
              ...context.repo,
              title: 'Setup: Enable CMS login with GitHub',
              labels: ['setup'],
              body: `## Enable the CMS admin panel

            Your site has been auto-configured, but the CMS needs a **GitHub OAuth App** to enable the "Login with GitHub" button.

            ### Steps

            1. Go to **[GitHub Developer Settings > OAuth Apps > New OAuth App](https://github.com/settings/applications/new)**
            2. Fill in:
               - **Application name:** \`${owner} site CMS\`
               - **Homepage URL:** \`${siteUrl}\`
               - **Authorization callback URL:** \`${adminUrl}\`
            3. Click **Register application**
            4. Copy the **Client ID** (you do NOT need the client secret)
            5. Edit \`config/cms.yml\` in this repo and set the \`app_id\`:
               \`\`\`yaml
               backend:
                 name: github
                 repo: "${context.repo.owner}/${context.repo.repo}"
                 branch: main
                 auth_type: pkce
                 app_id: "YOUR_CLIENT_ID_HERE"
               \`\`\`
            6. Commit the change â€” after the site rebuilds, go to [${adminUrl}](${adminUrl}) and click **Login with GitHub**

            ### Also required: GitHub Pages source

            Make sure GitHub Pages is set to deploy via **GitHub Actions** (not Jekyll):

            > [Settings > Pages](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/pages) > Build and deployment > Source > **GitHub Actions**

            ---
            *This issue was created automatically by the template initialization workflow. Close it once setup is complete.*`
            });
