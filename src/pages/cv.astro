---
import PageLayout from '../layouts/PageLayout.astro';
import PublicationEntry from '../components/astro/PublicationEntry.astro';
import { getCollection } from 'astro:content';
import { getSiteConfig, loadYamlConfig } from '../lib/config';
import type { CvConfig, CvMetadata } from '../lib/types';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

const config = getSiteConfig();

// Check raw YAML upload first, fall back to structured config
let cvConfig: CvConfig;
let usingUpload = false;
try {
  const upload = loadYamlConfig<{ enabled?: boolean; content?: string }>('cv-upload.yml');
  if (upload?.enabled && upload.content?.trim()) {
    const parsed = yaml.load(upload.content) as CvConfig;
    if (parsed?.cv) {
      cvConfig = parsed;
      usingUpload = true;
    } else {
      cvConfig = loadYamlConfig<CvConfig>('cv.yml');
    }
  } else {
    cvConfig = loadYamlConfig<CvConfig>('cv.yml');
  }
} catch {
  cvConfig = loadYamlConfig<CvConfig>('cv.yml');
}

const cv = cvConfig.cv;
const sections = cv.sections ?? {};

const publications = (await getCollection('publications'))
  .sort((a, b) => b.data.year - a.data.year);

// Load CV metadata if available (generated by render-cv.py)
let cvMeta: CvMetadata | null = null;
try {
  const metaPath = path.resolve(process.cwd(), 'src/data/cv.json');
  const raw = fs.readFileSync(metaPath, 'utf-8');
  cvMeta = JSON.parse(raw) as CvMetadata;
} catch {
  // No metadata yet — PDF hasn't been generated
}

const hasPdf = cvMeta?.pdfPath != null;
const pdfHref = hasPdf ? cvMeta!.pdfPath : '#';

function formatDateRange(start?: string, end?: string): string {
  if (!start) return '';
  const s = start.length === 7 ? start : start;
  const e = end === 'present' ? 'Present' : (end ?? '');
  return `${s} – ${e}`;
}
---

<PageLayout title="CV" description={`Curriculum Vitae of ${cv.name || config.author}`}>
  <div class="flex items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl sm:text-3xl font-serif font-normal text-surface-900 dark:text-[#e6edf3] mb-1">{cv.name || config.author}</h1>
      {cv.location && (
        <p class="text-sm text-surface-500 dark:text-[#8b949e]">{cv.location}</p>
      )}
      <p class="text-sm text-surface-500 dark:text-[#8b949e]">{config.department}, {config.university}</p>
      <div class="flex flex-wrap gap-3 mt-1 text-xs text-surface-500 dark:text-[#8b949e]">
        {cv.email && <span>{cv.email}</span>}
        {cv.website && <a href={cv.website} class="text-primary-600 dark:text-accent-400 hover:underline">{cv.website}</a>}
      </div>
    </div>
    <a
      href={pdfHref}
      class:list={[
        "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm rounded border border-surface-200 dark:border-[#21262d] transition-colors shrink-0",
        hasPdf
          ? "text-primary-600 dark:text-accent-400 hover:bg-surface-50 dark:hover:bg-[#161b22]"
          : "text-surface-400 dark:text-[#484f58] cursor-not-allowed pointer-events-none",
      ]}
      {...(hasPdf ? { download: "cv.pdf" } : {})}
    >
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      Download PDF
    </a>
  </div>

  {cvMeta?.lastGenerated && (
    <p class="text-xs text-surface-400 dark:text-[#484f58] mb-6">
      PDF last generated: {new Date(cvMeta.lastGenerated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
    </p>
  )}

  <!-- Education -->
  {sections.education && sections.education.length > 0 && (
    <section class="mb-8">
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Education
      </h2>
      <div class="space-y-3">
        {sections.education.map(edu => (
          <div>
            <div class="flex justify-between items-baseline">
              <div>
                <h3 class="text-sm font-medium text-surface-900 dark:text-[#e6edf3]">{edu.degree} in {edu.area}</h3>
                <p class="text-sm text-surface-500 dark:text-[#8b949e]">{edu.institution}</p>
              </div>
              <span class="text-xs text-surface-400 dark:text-[#484f58] shrink-0 ms-4">{formatDateRange(edu.startDate, edu.endDate)}</span>
            </div>
            {edu.highlights && edu.highlights.length > 0 && (
              <ul class="mt-1 text-xs text-surface-500 dark:text-[#8b949e] list-disc list-inside">
                {edu.highlights.map(h => <li>{h}</li>)}
              </ul>
            )}
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Experience -->
  {sections.experience && sections.experience.length > 0 && (
    <section class="mb-8">
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Experience
      </h2>
      <div class="space-y-3">
        {sections.experience.map(exp => (
          <div>
            <div class="flex justify-between items-baseline">
              <div>
                <h3 class="text-sm font-medium text-surface-900 dark:text-[#e6edf3]">{exp.position}</h3>
                <p class="text-sm text-surface-500 dark:text-[#8b949e]">{exp.company}</p>
              </div>
              <span class="text-xs text-surface-400 dark:text-[#484f58] shrink-0 ms-4">{formatDateRange(exp.startDate, exp.endDate)}</span>
            </div>
            {exp.highlights && exp.highlights.length > 0 && (
              <ul class="mt-1 text-xs text-surface-500 dark:text-[#8b949e] list-disc list-inside">
                {exp.highlights.map(h => <li>{h}</li>)}
              </ul>
            )}
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Publications -->
  {sections.publications && sections.publications.length > 0 ? (
    <section class="mb-8">
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Publications
        <a href="/publications" class="float-end text-xs font-sans text-primary-600 dark:text-accent-400 hover:underline">View all &rarr;</a>
      </h2>
      <div class="space-y-3">
        {sections.publications.map(pub => {
          const cleanAuthors = pub.authors.map(a => a.replace(/\*+/g, ''));
          return (
            <div class="text-sm">
              <p class="font-medium text-surface-900 dark:text-[#e6edf3]">{pub.title}</p>
              <p class="text-surface-500 dark:text-[#8b949e]">
                {pub.authors.map((author, i) => {
                  const clean = author.replace(/\*+/g, '');
                  const isBold = author.startsWith('**');
                  return (
                    <>
                      {i > 0 && ', '}
                      {isBold ? <strong>{clean}</strong> : <span>{clean}</span>}
                    </>
                  );
                })}
              </p>
              <p class="text-surface-400 dark:text-[#484f58]">
                {pub.journal && <span>{pub.journal}</span>}
                {pub.journal && pub.date && <span> · </span>}
                {pub.date && <span>{pub.date}</span>}
                {pub.doi && (
                  <>
                    <span> · </span>
                    <a href={`https://doi.org/${pub.doi}`} class="text-primary-600 dark:text-accent-400 hover:underline">DOI</a>
                  </>
                )}
                {pub.url && (
                  <>
                    <span> · </span>
                    <a href={pub.url} class="text-primary-600 dark:text-accent-400 hover:underline">Link</a>
                  </>
                )}
              </p>
            </div>
          );
        })}
      </div>
    </section>
  ) : (
    <section class="mb-8">
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Selected Publications
        <a href="/publications" class="float-end text-xs font-sans text-primary-600 dark:text-accent-400 hover:underline">View all &rarr;</a>
      </h2>
      <div class="space-y-3">
        {publications.slice(0, 5).map(pub => (
          <PublicationEntry
            title={pub.data.title}
            authors={pub.data.authors}
            venue={pub.data.venue}
            year={pub.data.year}
            doi={pub.data.doi}
            url={pub.data.url}
            type={pub.data.type}
            highlightAuthors={[config.author]}
          />
        ))}
      </div>
    </section>
  )}

  <!-- Awards -->
  {sections.awards && sections.awards.length > 0 && (
    <section class="mb-8">
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Awards & Honors
      </h2>
      <div class="space-y-2">
        {sections.awards.map(item => (
          <div class="flex justify-between items-center text-sm">
            <span class="text-surface-700 dark:text-[#c9d1d9]">{item.label}</span>
            <span class="text-xs text-surface-400 dark:text-[#484f58]">{item.details}</span>
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Skills -->
  {sections.skills && sections.skills.length > 0 && (
    <section>
      <h2 class="text-lg font-serif font-normal text-surface-900 dark:text-[#e6edf3] pb-2 border-b border-surface-200 dark:border-[#21262d] mb-3">
        Skills
      </h2>
      <div class="space-y-2">
        {sections.skills.map(item => (
          <div class="flex items-baseline gap-2 text-sm">
            <span class="font-medium text-surface-900 dark:text-[#e6edf3] shrink-0">{item.label}:</span>
            <span class="text-surface-600 dark:text-[#c9d1d9]">{item.details}</span>
          </div>
        ))}
      </div>
    </section>
  )}
</PageLayout>
